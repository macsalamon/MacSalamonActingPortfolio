---
const { translations, currentLang } = Astro.props;
const t = translations[currentLang];
const photos = t.gallery.photos || [];
---

<div class="gallery-container">
  <div class="gallery-track" id="gallery-track">
    {photos.map((photo) => (
      <div class="gallery-photo">
        <img
          src={photo.src}
          alt={photo.alt}
          loading="lazy"
          data-zoom-src={photo.src}
        />
      </div>
    ))}
  </div>

  <div class="gallery-controls">
    <button class="gallery-button" id="gallery-prev">←</button>
    <button class="gallery-button" id="gallery-play-pause">⏸ Pause</button>
    <button class="gallery-button" id="gallery-next">→</button>
  </div>
</div>

<!-- Zoom Modal -->
<div class="gallery-zoom-modal hidden" id="zoom-modal">
  <div class="zoom-overlay" id="zoom-overlay"></div>
  <img src="" alt="" id="zoom-image" />
  <button class="zoom-close" id="zoom-close">×</button>
</div>

<style>
  .gallery-container {
    position: relative;
    max-width: 1000px;
    margin: 0 auto;
  }

  .gallery-track {
    display: flex;
    gap: var(--spacing-md);
    overflow: hidden;
    transition: transform 0.5s ease;
  }

  .gallery-photo {
    flex: 0 0 100%;
    max-width: 100%;
    aspect-ratio: 3 / 4;
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    cursor: zoom-in;
    transition: transform var(--transition);
  }

  .gallery-photo:hover {
    transform: scale(1.02);
  }

  .gallery-photo img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .gallery-controls {
    display: flex;
    gap: var(--spacing-sm);
    justify-content: center;
    margin-top: var(--spacing-md);
  }

  .gallery-button {
    padding: 12px 24px;
    border: 2px solid var(--color-border);
    border-radius: var(--border-radius);
    background: linear-gradient(135deg, var(--color-gradient-light-from), var(--color-gradient-light-to));
    color: var(--color-text);
    font-weight: 600;
    font-size: 15px;
    transition: all var(--transition);
  }

  .gallery-button:hover {
    border-color: var(--color-accent);
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
  }

  .gallery-button:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  /* Zoom Modal */
  .gallery-zoom-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .gallery-zoom-modal.hidden {
    display: none;
  }

  .zoom-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    cursor: zoom-out;
  }

  #zoom-image {
    position: relative;
    max-width: 90vw;
    max-height: 90vh;
    object-fit: contain;
    z-index: 10000;
    border-radius: var(--border-radius);
    box-shadow: 0 12px 48px rgba(0, 0, 0, 0.5);
    cursor: zoom-out;
  }

  .zoom-close {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.9);
    color: var(--color-text);
    font-size: 32px;
    border: none;
    cursor: pointer;
    z-index: 10001;
    transition: all var(--transition);
  }

  .zoom-close:hover {
    background: white;
    transform: rotate(90deg);
  }

  @media (min-width: 769px) {
    .gallery-photo {
      flex: 0 0 calc(50% - var(--spacing-md) / 2);
    }
  }

  @media (max-width: 768px) {
    .gallery-photo {
      flex: 0 0 100%;
    }

    .gallery-button {
      padding: 10px 16px;
      font-size: 14px;
    }
  }
</style>

<script>
  let currentIndex = 0;
  let autoRotateInterval = null;
  let isPlaying = true;

  function initPhotoGallery() {
    const track = document.getElementById('gallery-track');
    const prevButton = document.getElementById('gallery-prev');
    const nextButton = document.getElementById('gallery-next');
    const playPauseButton = document.getElementById('gallery-play-pause');
    const photos = track?.querySelectorAll('.gallery-photo');
    const zoomModal = document.getElementById('zoom-modal');
    const zoomImage = document.getElementById('zoom-image');
    const zoomClose = document.getElementById('zoom-close');
    const zoomOverlay = document.getElementById('zoom-overlay');

    if (!track || !photos || photos.length === 0) return;

    const totalPhotos = photos.length;
    const photosPerView = window.innerWidth >= 769 ? 2 : 1;
    const maxIndex = Math.max(0, totalPhotos - photosPerView);

    function updateGallery() {
      if (!track || !photos || photos.length === 0) return;

      const photoCard = photos[0];
      const cardWidth = photoCard.offsetWidth;
      const gap = 24; // --spacing-md
      const scrollAmount = cardWidth + gap;
      const offset = currentIndex * scrollAmount;

      track.style.transform = `translateX(-${offset}px)`;
    }

    function goToNext() {
      if (currentIndex < maxIndex) {
        currentIndex++;
      } else {
        currentIndex = 0; // Loop back to start
      }
      updateGallery();
    }

    function goToPrev() {
      if (currentIndex > 0) {
        currentIndex--;
      } else {
        currentIndex = maxIndex; // Loop to end
      }
      updateGallery();
    }

    function startAutoRotate() {
      stopAutoRotate();
      autoRotateInterval = setInterval(goToNext, 4000); // Rotate every 4 seconds
      isPlaying = true;
      if (playPauseButton) playPauseButton.textContent = '⏸ Pause';
    }

    function stopAutoRotate() {
      if (autoRotateInterval) {
        clearInterval(autoRotateInterval);
        autoRotateInterval = null;
      }
      isPlaying = false;
      if (playPauseButton) playPauseButton.textContent = '▶ Play';
    }

    function togglePlayPause() {
      if (isPlaying) {
        stopAutoRotate();
      } else {
        startAutoRotate();
      }
    }

    // Navigation button listeners
    prevButton?.addEventListener('click', () => {
      stopAutoRotate();
      goToPrev();
    });

    nextButton?.addEventListener('click', () => {
      stopAutoRotate();
      goToNext();
    });

    playPauseButton?.addEventListener('click', togglePlayPause);

    // Zoom functionality
    photos.forEach(photo => {
      const img = photo.querySelector('img');
      img?.addEventListener('click', () => {
        const src = img.getAttribute('data-zoom-src') || img.src;
        zoomImage.src = src;
        zoomImage.alt = img.alt;
        zoomModal?.classList.remove('hidden');
        stopAutoRotate();
      });
    });

    // Close zoom modal
    function closeZoom() {
      zoomModal?.classList.add('hidden');
      if (!isPlaying) {
        startAutoRotate();
      }
    }

    zoomClose?.addEventListener('click', closeZoom);
    zoomOverlay?.addEventListener('click', closeZoom);
    zoomImage?.addEventListener('click', closeZoom);

    // Escape key to close zoom
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !zoomModal?.classList.contains('hidden')) {
        closeZoom();
      }
    });

    // Handle window resize
    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        currentIndex = 0;
        updateGallery();
      }, 250);
    });

    updateGallery();
    startAutoRotate();
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPhotoGallery);
  } else {
    initPhotoGallery();
  }

  // Re-initialize when language changes
  window.updatePhotoGallery = initPhotoGallery;
</script>
