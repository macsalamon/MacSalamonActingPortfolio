---
const tracks = [
  { file: '/media/voiceover/01-Commercials-DE.mp3', title: 'Commercials DE' },
  { file: '/media/voiceover/02-Commercials-PL.mp3', title: 'Commercials PL' },
  { file: '/media/voiceover/03-Characters-DE.mp3', title: 'Characters DE' },
  { file: '/media/voiceover/04-Characters-PL.mp3', title: 'Characters PL' },
  { file: '/media/voiceover/05-Narration-DE.mp3', title: 'Narration DE' },
  { file: '/media/voiceover/06-Narration-PL.mp3', title: 'Narration PL' },
  { file: '/media/voiceover/07-Characters-EN.mp3', title: 'Characters EN' },
  { file: '/media/voiceover/08-Narration-EN.mp3', title: 'Narration EN' },
];
---

<div class="audio-player" id="audio-player">
  <audio id="audio-element" preload="metadata"></audio>

  <!-- Now Playing -->
  <div class="ap-now-playing" id="ap-now-playing">
    <span class="ap-track-label">â€”</span>
  </div>

  <!-- Progress Bar -->
  <div class="ap-progress-container" id="ap-progress-container">
    <div class="ap-progress-bar" id="ap-progress-bar"></div>
  </div>
  <div class="ap-time">
    <span id="ap-current-time">0:00</span>
    <span id="ap-duration">0:00</span>
  </div>

  <!-- Controls -->
  <div class="ap-controls">
    <button class="ap-btn" id="ap-prev" aria-label="Previous track" title="Previous">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
    </button>
    <button class="ap-btn ap-btn-play" id="ap-play" aria-label="Play" title="Play">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" id="ap-play-icon"><polygon points="5,3 19,12 5,21"/></svg>
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" id="ap-pause-icon" style="display:none"><path d="M6 4h4v16H6zM14 4h4v16h-4z"/></svg>
    </button>
    <button class="ap-btn" id="ap-next" aria-label="Next track" title="Next">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
    </button>
    <a class="ap-btn ap-btn-download" id="ap-download" href="#" download aria-label="Download current track" title="Download">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
    </a>
  </div>

  <!-- Track List -->
  <div class="ap-tracklist" id="ap-tracklist">
    {tracks.map((track, i) => (
      <button class="ap-track-item" data-index={i} data-src={track.file} data-title={track.title}>
        <span class="ap-track-num">{String(i + 1).padStart(2, '0')}</span>
        <span class="ap-track-title">{track.title}</span>
        <span class="ap-track-playing-icon">&#9654;</span>
      </button>
    ))}
  </div>
</div>

<style>
  .audio-player {
    background: rgba(255, 255, 255, 0.6);
    border: 2px solid var(--color-border);
    border-radius: var(--border-radius);
    padding: var(--spacing-md);
    max-width: 500px;
  }

  .ap-now-playing {
    text-align: center;
    margin-bottom: var(--spacing-sm);
    font-weight: 600;
    font-size: 15px;
    color: var(--color-text);
    min-height: 1.4em;
  }

  .ap-progress-container {
    width: 100%;
    height: 6px;
    background: var(--color-surface);
    border-radius: 3px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
  }

  .ap-progress-bar {
    height: 100%;
    width: 0%;
    background: var(--color-accent);
    border-radius: 3px;
    transition: width 0.1s linear;
  }

  .ap-time {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: var(--color-text-muted);
    margin-top: 4px;
    margin-bottom: var(--spacing-sm);
    font-variant-numeric: tabular-nums;
  }

  .ap-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-md);
  }

  .ap-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 2px solid var(--color-border);
    background: linear-gradient(135deg, var(--color-gradient-light-from), var(--color-gradient-light-to));
    color: var(--color-text);
    cursor: pointer;
    transition: all var(--transition);
  }

  .ap-btn:hover {
    border-color: var(--color-accent);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .ap-btn-play {
    width: 52px;
    height: 52px;
    background: var(--color-accent);
    color: white;
    border-color: var(--color-accent);
  }

  .ap-btn-play:hover {
    background: var(--color-accent-hover);
    border-color: var(--color-accent-hover);
    color: white;
  }

  .ap-btn-download {
    text-decoration: none;
    color: var(--color-text);
  }

  .ap-btn-download:hover {
    color: var(--color-text);
  }

  .ap-tracklist {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .ap-track-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: 10px 12px;
    border: none;
    background: transparent;
    border-radius: 8px;
    cursor: pointer;
    transition: all var(--transition);
    text-align: left;
    font-family: inherit;
    font-size: 14px;
    color: var(--color-text);
    width: 100%;
  }

  .ap-track-item:hover {
    background: rgba(0, 0, 0, 0.05);
  }

  .ap-track-item.active {
    background: rgba(0, 0, 0, 0.08);
    font-weight: 600;
  }

  .ap-track-num {
    font-size: 12px;
    color: var(--color-text-muted);
    font-weight: 600;
    min-width: 22px;
  }

  .ap-track-title {
    flex: 1;
  }

  .ap-track-playing-icon {
    font-size: 10px;
    color: var(--color-accent);
    opacity: 0;
    transition: opacity var(--transition);
  }

  .ap-track-item.active .ap-track-playing-icon {
    opacity: 1;
  }
</style>

<script>
  function initAudioPlayer() {
    const audio = document.getElementById('audio-element') as HTMLAudioElement;
    const playBtn = document.getElementById('ap-play');
    const playIcon = document.getElementById('ap-play-icon');
    const pauseIcon = document.getElementById('ap-pause-icon');
    const prevBtn = document.getElementById('ap-prev');
    const nextBtn = document.getElementById('ap-next');
    const downloadBtn = document.getElementById('ap-download') as HTMLAnchorElement;
    const progressContainer = document.getElementById('ap-progress-container');
    const progressBar = document.getElementById('ap-progress-bar');
    const currentTimeEl = document.getElementById('ap-current-time');
    const durationEl = document.getElementById('ap-duration');
    const nowPlaying = document.querySelector('#ap-now-playing .ap-track-label');
    const trackItems = document.querySelectorAll('.ap-track-item');

    if (!audio || !trackItems.length) return;

    let currentIndex = -1;
    let isPlaying = false;

    function formatTime(seconds: number): string {
      if (isNaN(seconds)) return '0:00';
      const m = Math.floor(seconds / 60);
      const s = Math.floor(seconds % 60);
      return `${m}:${s.toString().padStart(2, '0')}`;
    }

    function loadTrack(index: number, autoplay = false) {
      const item = trackItems[index] as HTMLElement;
      if (!item) return;

      currentIndex = index;
      const src = item.dataset.src || '';
      const title = item.dataset.title || '';

      audio.src = src;
      audio.load();
      if (nowPlaying) nowPlaying.textContent = title;
      if (downloadBtn) {
        downloadBtn.href = src;
        downloadBtn.setAttribute('download', src.split('/').pop() || 'track.mp3');
      }

      // Update active state
      trackItems.forEach(t => t.classList.remove('active'));
      item.classList.add('active');

      if (autoplay) {
        audio.play();
        isPlaying = true;
        updatePlayButton();
      }
    }

    function updatePlayButton() {
      if (playIcon && pauseIcon) {
        playIcon.style.display = isPlaying ? 'none' : 'block';
        pauseIcon.style.display = isPlaying ? 'block' : 'none';
      }
      if (playBtn) {
        playBtn.setAttribute('aria-label', isPlaying ? 'Pause' : 'Play');
        playBtn.setAttribute('title', isPlaying ? 'Pause' : 'Play');
      }
    }

    function togglePlay() {
      if (currentIndex === -1) {
        loadTrack(0, true);
        return;
      }
      if (isPlaying) {
        audio.pause();
      } else {
        audio.play();
      }
    }

    function skipNext() {
      if (trackItems.length === 0) return;
      const next = (currentIndex + 1) % trackItems.length;
      loadTrack(next, isPlaying);
    }

    function skipPrev() {
      if (trackItems.length === 0) return;
      // If more than 3 seconds in, restart current track
      if (audio.currentTime > 3) {
        audio.currentTime = 0;
        return;
      }
      const prev = (currentIndex - 1 + trackItems.length) % trackItems.length;
      loadTrack(prev, isPlaying);
    }

    // Event listeners
    playBtn?.addEventListener('click', togglePlay);
    nextBtn?.addEventListener('click', skipNext);
    prevBtn?.addEventListener('click', skipPrev);

    audio.addEventListener('play', () => {
      isPlaying = true;
      updatePlayButton();
    });

    audio.addEventListener('pause', () => {
      isPlaying = false;
      updatePlayButton();
    });

    audio.addEventListener('ended', skipNext);

    audio.addEventListener('timeupdate', () => {
      if (audio.duration) {
        const pct = (audio.currentTime / audio.duration) * 100;
        if (progressBar) progressBar.style.width = `${pct}%`;
        if (currentTimeEl) currentTimeEl.textContent = formatTime(audio.currentTime);
      }
    });

    audio.addEventListener('loadedmetadata', () => {
      if (durationEl) durationEl.textContent = formatTime(audio.duration);
    });

    // Click on progress bar to seek
    progressContainer?.addEventListener('click', (e) => {
      if (!audio.duration) return;
      const rect = progressContainer.getBoundingClientRect();
      const pct = (e.clientX - rect.left) / rect.width;
      audio.currentTime = pct * audio.duration;
    });

    // Click track in list
    trackItems.forEach((item, index) => {
      item.addEventListener('click', () => {
        loadTrack(index, true);
      });
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAudioPlayer);
  } else {
    initAudioPlayer();
  }
</script>
