---
import { Image } from 'astro:assets';

const { translations, currentLang } = Astro.props;
const t = translations[currentLang];

// Dynamically import all gallery images
const images = import.meta.glob<{ default: ImageMetadata }>('../assets/headshots/gallery/*.jpg', { eager: true });

// Sort images by filename (1.jpg, 2.jpg, ..., 15.jpg)
const sortedImages = Object.entries(images).sort((a, b) => {
  const numA = parseInt(a[0].match(/\/(\d+)\.jpg$/)?.[1] || '0');
  const numB = parseInt(b[0].match(/\/(\d+)\.jpg$/)?.[1] || '0');
  return numA - numB;
});

const galleryPhotos = sortedImages.map(([path, module]) => ({
  image: module.default,
  alt: t.gallery.photos?.[0]?.alt || 'Headshot photo',
  path
}));
---

<div class="gallery-container">
  <div class="gallery-track" id="carousel-gallery-track">
    {galleryPhotos.map((photo, index) => (
      <div class="gallery-photo" data-index={index}>
        <Image
          src={photo.image}
          alt={`${photo.alt} ${index + 1}`}
          width={800}
          height={1067}
          quality={85}
          format="webp"
          loading={index < 4 ? 'eager' : 'lazy'}
          class="gallery-img"
          data-zoom-index={index}
        />
      </div>
    ))}
  </div>

  <div class="gallery-controls">
    <button class="gallery-button" id="carousel-gallery-prev">←</button>
    <button class="gallery-button" id="carousel-gallery-play-pause">⏸ Pause</button>
    <button class="gallery-button" id="carousel-gallery-next">→</button>
  </div>
</div>

<!-- Zoom Modal -->
<div class="gallery-zoom-modal hidden" id="carousel-zoom-modal">
  <div class="zoom-overlay" id="carousel-zoom-overlay"></div>
  <div class="zoom-image-wrapper" id="carousel-zoom-image-wrapper">
    {galleryPhotos.map((photo, index) => (
      <Image
        src={photo.image}
        alt={`${photo.alt} ${index + 1}`}
        width={1600}
        height={2133}
        quality={90}
        format="webp"
        loading="lazy"
        class="carousel-zoom-image hidden"
        data-zoom-index={index}
      />
    ))}
  </div>
  <button class="zoom-close" id="carousel-zoom-close">×</button>
</div>

<style>
  .gallery-container {
    position: relative;
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 var(--spacing-sm);
    overflow: hidden;
  }

  .gallery-track {
    display: flex;
    gap: var(--spacing-md);
    transition: transform 0.5s ease;
    will-change: transform;
  }

  .gallery-photo {
    flex: 0 0 100%;
    max-width: 100%;
    aspect-ratio: 3 / 4;
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    cursor: zoom-in;
    transition: transform var(--transition);
  }

  .gallery-photo:hover {
    transform: scale(1.02);
  }

  .gallery-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    image-rendering: -webkit-optimize-contrast;
  }

  .gallery-controls {
    display: flex;
    gap: var(--spacing-sm);
    justify-content: center;
    margin-top: var(--spacing-md);
  }

  .gallery-button {
    padding: 12px 24px;
    border: 2px solid var(--color-border);
    border-radius: var(--border-radius);
    background: linear-gradient(135deg, var(--color-gradient-light-from), var(--color-gradient-light-to));
    color: var(--color-text);
    font-weight: 600;
    font-size: 15px;
    transition: all var(--transition);
  }

  .gallery-button:hover {
    border-color: var(--color-accent);
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
  }

  .gallery-button:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  /* Zoom Modal */
  .gallery-zoom-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .gallery-zoom-modal.hidden {
    display: none;
  }

  .zoom-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    cursor: zoom-out;
  }

  .zoom-image-wrapper {
    position: relative;
    max-width: 90vw;
    max-height: 90vh;
    z-index: 10000;
  }

  .carousel-zoom-image {
    max-width: 90vw;
    max-height: 90vh;
    object-fit: contain;
    border-radius: var(--border-radius);
    box-shadow: 0 12px 48px rgba(0, 0, 0, 0.5);
    cursor: zoom-out;
  }

  .carousel-zoom-image.hidden {
    display: none;
  }

  .zoom-close {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.9);
    color: var(--color-text);
    font-size: 32px;
    border: none;
    cursor: pointer;
    z-index: 10001;
    transition: all var(--transition);
  }

  .zoom-close:hover {
    background: white;
    transform: rotate(90deg);
  }

  @media (min-width: 1051px) {
    .gallery-photo {
      flex: 0 0 calc(25% - (var(--spacing-md) * 3 / 4));
    }
  }

  @media (min-width: 769px) and (max-width: 1050px) {
    .gallery-photo {
      flex: 0 0 calc(50% - var(--spacing-md) / 2);
    }
  }

  @media (max-width: 768px) {
    .gallery-photo {
      flex: 0 0 100%;
    }

    .gallery-button {
      padding: 10px 16px;
      font-size: 14px;
    }
  }
</style>

<script>
  let currentIndex = 0;
  let autoRotateInterval: number | null = null;
  let isPlaying = true;

  function initPhotoGallery() {
    const track = document.getElementById('carousel-gallery-track');
    const prevButton = document.getElementById('carousel-gallery-prev');
    const nextButton = document.getElementById('carousel-gallery-next');
    const playPauseButton = document.getElementById('carousel-gallery-play-pause');
    const photos = track?.querySelectorAll('.gallery-photo');
    const zoomModal = document.getElementById('carousel-zoom-modal');
    const zoomImages = document.querySelectorAll('.carousel-zoom-image');
    const zoomClose = document.getElementById('carousel-zoom-close');
    const zoomOverlay = document.getElementById('carousel-zoom-overlay');

    if (!track || !photos || photos.length === 0) return;

    const totalPhotos = photos.length;

    function getPhotosPerView() {
      if (window.innerWidth >= 1051) return 4;
      if (window.innerWidth >= 769) return 2;
      return 1;
    }

    let photosPerView = getPhotosPerView();
    let maxIndex = Math.max(0, totalPhotos - photosPerView);

    function updateGallery() {
      if (!track || !photos || photos.length === 0) return;

      const photoCard = photos[0] as HTMLElement;
      const cardWidth = photoCard.offsetWidth;
      const gap = 24; // --spacing-md
      const scrollAmount = cardWidth + gap;
      const offset = currentIndex * scrollAmount;

      track.style.transform = `translateX(-${offset}px)`;
    }

    function goToNext() {
      if (currentIndex < maxIndex) {
        currentIndex++;
      } else {
        currentIndex = 0; // Loop back to start
      }
      updateGallery();
    }

    function goToPrev() {
      if (currentIndex > 0) {
        currentIndex--;
      } else {
        currentIndex = maxIndex; // Loop to end
      }
      updateGallery();
    }

    function startAutoRotate() {
      stopAutoRotate();
      autoRotateInterval = setInterval(goToNext, 4000); // Rotate every 4 seconds
      isPlaying = true;
      if (playPauseButton) playPauseButton.textContent = '⏸ Pause';
    }

    function stopAutoRotate() {
      if (autoRotateInterval) {
        clearInterval(autoRotateInterval);
        autoRotateInterval = null;
      }
      isPlaying = false;
      if (playPauseButton) playPauseButton.textContent = '▶ Play';
    }

    function togglePlayPause() {
      if (isPlaying) {
        stopAutoRotate();
      } else {
        startAutoRotate();
      }
    }

    // Navigation button listeners
    prevButton?.addEventListener('click', () => {
      stopAutoRotate();
      goToPrev();
    });

    nextButton?.addEventListener('click', () => {
      stopAutoRotate();
      goToNext();
    });

    playPauseButton?.addEventListener('click', togglePlayPause);

    // Zoom functionality
    photos.forEach(photo => {
      const img = photo.querySelector('img');
      img?.addEventListener('click', () => {
        const zoomIndex = img.getAttribute('data-zoom-index');
        if (zoomIndex !== null) {
          // Hide all zoom images
          zoomImages.forEach(zImg => zImg.classList.add('hidden'));
          // Show the clicked image
          const targetZoomImage = document.querySelector(`.carousel-zoom-image[data-zoom-index="${zoomIndex}"]`);
          targetZoomImage?.classList.remove('hidden');
          zoomModal?.classList.remove('hidden');
          stopAutoRotate();
        }
      });
    });

    // Close zoom modal
    function closeZoom() {
      zoomModal?.classList.add('hidden');
      zoomImages.forEach(img => img.classList.add('hidden'));
      if (!isPlaying) {
        startAutoRotate();
      }
    }

    zoomClose?.addEventListener('click', closeZoom);
    zoomOverlay?.addEventListener('click', closeZoom);
    zoomImages.forEach(img => {
      img.addEventListener('click', closeZoom);
    });

    // Escape key to close zoom
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !zoomModal?.classList.contains('hidden')) {
        closeZoom();
      }
    });

    // Handle window resize
    let resizeTimer: number;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        photosPerView = getPhotosPerView();
        maxIndex = Math.max(0, totalPhotos - photosPerView);
        currentIndex = 0;
        updateGallery();
      }, 250);
    });

    updateGallery();
    startAutoRotate();
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPhotoGallery);
  } else {
    initPhotoGallery();
  }

  // Re-initialize when language changes or tab switches
  (window as any).updatePhotoGallery = initPhotoGallery;
  (window as any).updateCarouselGallery = initPhotoGallery;
</script>
